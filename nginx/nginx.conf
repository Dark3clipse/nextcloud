user  root;
worker_processes  auto;

error_log  /var/log/nginx/error.log warn;
pid        /var/run/nginx.pid;

events {
    worker_connections  1024;
}


http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    access_log  /var/log/nginx/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    keepalive_timeout  65;

    resolver 127.0.0.11 valid=30s;

	set_real_ip_from  10.0.0.0/8;
    set_real_ip_from  172.16.0.0/12;
    set_real_ip_from  192.168.0.0/16;
    real_ip_header    X-Real-IP;

    #gzip  on;

	# nextcloud php handler
	upstream php-handler {
        server nextcloud:9000;
    }

    include /etc/nginx/conf.d/*.conf;
}


mail {
    server_name hadash.nl;
    auth_http http://smtp:10025/auth/email;
    proxy_pass_error_message on;
    resolver 127.0.0.11 valid=30s;


    ssl_certificate     /etc/letsencrypt/live/hadash.nl/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/hadash.nl/privkey.pem;
    ssl_session_timeout 1d;
    ssl_session_tickets off;
    ssl_dhparam /etc/letsencrypt/dhparam-2048.pem;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;

    ssl_session_cache shared:SSLMAIL:50m;


    # Advertise real capabilites of backends (postfix/dovecot)
    smtp_capabilities PIPELINING SIZE 200000000 ETRN ENHANCEDSTATUSCODES 8BITMIME DSN CHUNKING;
    pop3_capabilities TOP UIDL RESP-CODES PIPELINING AUTH-RESP-CODE USER;
    imap_capabilities IMAP4 IMAP4rev1 UIDPLUS SASL-IR LOGIN-REFERRALS ID ENABLE IDLE LITERAL+;

    # Default SMTP server for the webmail (no encryption, but authentication)
    server {
		listen 10025;
		protocol smtp;
		smtp_auth plain;
    }

    # Default IMAP server for the webmail (no encryption, but authentication)
    server {
		listen 10143;
		protocol imap;
		smtp_auth plain;
    }

    # SMTP is always enabled, to avoid losing emails when TLS is failing
    server {
		listen 25;
		listen [::]:25;

		ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
		ssl_ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES256-SHA256:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:DES-CBC3-SHA;
		ssl_prefer_server_ciphers on;
		starttls on;

		protocol smtp;
		smtp_auth none;
    }

    # All other protocols are disabled if TLS is failing

    server {
		listen 143;
		listen [::]:143;

		starttls only;

		protocol imap;
		imap_auth plain;
    }

    server {
		listen 110;
		listen [::]:110;

		starttls only;

		protocol pop3;
		pop3_auth plain;
    }

    server {
		listen 587;
		listen [::]:587;

		starttls only;

		protocol smtp;
		smtp_auth plain login;
    }


    server {
		listen 465 ssl;
		listen [::]:465 ssl;
		protocol smtp;
		smtp_auth plain login;
    }

    server {
		listen 993 ssl;
		listen [::]:993 ssl;
		protocol imap;
		imap_auth plain;
    }

    server {
		listen 995 ssl;
		listen [::]:995 ssl;
		protocol pop3;
		pop3_auth plain;
    }
}